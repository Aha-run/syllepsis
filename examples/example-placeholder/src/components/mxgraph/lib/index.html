<!DOCTYPE html>
<html>
<head>
  <title>流程图</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" type="text/css" href="styles/grapheditor.css">
  <style>
    .geMenubarContainer {
      display: none;
    }

    . geToolbarContainer {
      top: 0 !important;
    }
  </style>
  <script type="text/javascript">
    window.urlParams = (function (url) {
      const result = {};
      let idx = url.lastIndexOf('?');
      if (idx > 0) {
        const params = url.substring(idx + 1).split('&');
        for (let i = 0; i < params.length; i++) {
          idx = params[i].indexOf('=');
          if (idx > 0) {
            result[params[i].substring(0, idx)] = params[i].substring(idx + 1);
          }
        }
      }
      return result;
    })(window.location.href);
    // 加载资源
    mxLoadResources = false;
  </script>
  <script type="text/javascript" src="js/Init.js"></script>
  <script type="text/javascript" src="deflate/pako.min.js"></script>
  <script type="text/javascript" src="deflate/base64.js"></script>
  <script type="text/javascript" src="jscolor/jscolor.js"></script>
  <script type="text/javascript" src="sanitizer/sanitizer.min.js"></script>
  <script type="text/javascript" src="js/mxClient.js"></script>
  <script type="text/javascript" src="js/EditorUi.js"></script>
  <script type="text/javascript" src="js/Editor.js"></script>
  <script type="text/javascript" src="js/Sidebar.js"></script>
  <script type="text/javascript" src="js/Graph.js"></script>
  <script type="text/javascript" src="js/Format.js"></script>
  <script type="text/javascript" src="js/Shapes.js"></script>
  <script type="text/javascript" src="js/Actions.js"></script>
  <script type="text/javascript" src="js/Menus.js"></script>
  <script type="text/javascript" src="js/Toolbar.js"></script>
  <script type="text/javascript" src="js/Dialogs.js"></script>
  <script type="text/javascript">
    (function () {

      const editorUiInit = window.EditorUi.prototype.init;

      // 初始化UI
      window.EditorUi.prototype.init = function () {
        editorUiInit.apply(this, arguments);
        this.actions.get('export').setEnabled(true);
      };

      // 加载资源
      window.mxResources.loadDefaultBundle = false;
      const bundle = window.mxResources.getDefaultBundle(window.RESOURCE_BASE, window.mxLanguage) ||
        window.mxResources.getSpecialBundle(window.RESOURCE_BASE, window.mxLanguage);

      // 加载资源 并 初始化编辑器
      window.mxUtils.getAll([bundle, window.STYLE_PATH + '/default.xml'], (xhr) => {
        window.mxResources.parse(xhr[0].getText());

        // 主入口
        const container = document.querySelector('.graphic-container');
        const themes = {};
        // 手绘风格（和飞书保持一致）
        themes[window.Graph.prototype.defaultThemeName] = xhr[1].getDocumentElement();

        const editor = new window.Editor(false, themes);
        window.app = new window.EditorUi(editor, container);

        // 导出
        // const xml = editor.getGraphXml().outerHTML;
        const id = window.location.search.substr('4');

        function send(cmd, data, id) {
          window.parent.postMessage({
            id,
            method: cmd,
            data
          });
        }

        // iframe通讯
        send('mxgraph-ready', {id});
        window.addEventListener('message', receiveMessage, false);
        const ACCEPT_CMD = {
          SET_DATA: 'setData',
          GET_SVG: 'getSvg',
          SCROLL_TO_VISIBLE: 'scrollToVisible',
        }

        // 获取Svg并向外传递
        function setSvg() {
          const svg = window.app.editor.graph.getSvg().outerHTML;
          const xml = window.app.editor.getGraphXml().outerHTML;
          send('mxgraph-getSvg', {
            svg, xml, id
          });
        }

        function scrollToVisible() {
          if (window.app.editor.graph.model.cells[2]) {
            window.app.editor.graph.scrollCellToVisible(window.app.editor.graph.model.cells[2]);
          }
        }

        // 接受到了命令
        function receiveMessage(event) {
          const cmd = event.data;
          switch (cmd.method) {
            case ACCEPT_CMD.SET_DATA: {
              const xmlDoc = window.mxUtils.parseXml(cmd.data);
              window.app.editor.setGraphXml(xmlDoc.documentElement);
              break;
            }
            case ACCEPT_CMD.GET_SVG: {
              setSvg();
              break;
            }
            case ACCEPT_CMD.SCROLL_TO_VISIBLE: {
              scrollToVisible();
              break;
            }
            default: {
              console.warn('未能识别该命令', event);
            }
          }
        }

        // 事件监听
        window.app.editor.graph.model.addListener(window.mxEvent.CHANGE, () => {
          setSvg();
        });
        window.app.editor.graph.getCellAt(0)
        // 通知退出全屏
        window.addEventListener('keydown', (event) => {
          if (event.keyCode === 27) {
            send('mxgraph-esc', {id});
          }
        })
      });
    })();
  </script>
</head>
<body>
<div class="graphic-container"></div>
</body>
</html>
